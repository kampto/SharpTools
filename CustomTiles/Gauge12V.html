<!-- kampto  ver. April25-2021, for SharpTools -->
<!-- Do not edit below -->
<script type="application/json" id="tile-settings">
{
  "schema": "0.1.0",
  "settings": [
    {"label": "Sample Maker API URL", "name": "apiSample", "type": "STRING"},
    {"label": "Device ID", "type": "STRING", "name": "deviceId"},
    {
      "label": "GaugeLabel (default=Volts)",
      "type": "STRING",
      "name": "gaugeLabel"
    },
    {"label": "Units (default=V)", "name": "gaugeUnits", "type": "STRING"},
    {
      "label": "Number of Decimals (default = 2)",
      "name": "numDecimals",
      "type": "STRING"
    },
    {
      "name": "refreshInterv",
      "type": "NUMBER",
      "label": "Refresh Interval Minutes (default = 10)"
    },
    {
      "label": "If multiple attributes select another,  0 to 4 (default = 0)",
      "name": "hubAttribute",
      "type": "NUMBER"
    }
  ],
  "name": "Gauge 12V",
  "dimensions": {"width": 2, "height": 2}
}
</script>
<!-- Do not edit above -->
<style>
  html, body { height: 100% };
  #chart { height: 100%; width: 100%;}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<script src="https://cdn.sharptools.io/js/custom-tiles.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<div id="chart" align="center"></div>
<script>

//Optional, force API URI into every tile, DO NOT SHARE CODE IF REAL API URL INSERTED BELOW
  var tileSettings = { 
    // apiSample: "https://cloud.hubitat.com/api/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/apps/999/devices?access_token=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX", 
    // deviceId: "185",
 }
  var apiSettings = {};
  
//********************* SET UP GAUGE BOUNDARYS *********************
//******************************************************************  
  var chart, chartData;
  var chartOptions = {
    min: 10.5, max: 14.5,
    redFrom: 10.5, redTo: 11.5,
    yellowFrom:11.5, yellowTo: 12.0,
    greenFrom:12.0, greenTo: 14.5,
    minorTicks: 5
  };
//*******************************************************************
//*******************************************************************  
  
  //Load gauge script
  google.charts.load('current', {'packages':['gauge']});  
  google.charts.setOnLoadCallback(initChart);  
  
  stio.ready(function(data){
    //get the settings from the callback
    tileSettings = data.settings; //apiSample, deviceId, label
    //and initialize the tile
    init();
  });

  function init(){
    //parse the relevant settings out of the apiSample
    parseApiSample();

    if(tileSettings.deviceId == null || tileSettings.deviceId == ""){
      return showError("Device ID is not set");
    } 

//Call data from Hubitat Maker API then tiem out till next call
    valuePollingScheduler();
  }

  //helper method for logging an error to console, showing a toast, and updating the tile to display 'Error'
  function showError(message){
    console.error(message);
    stio.showToast(message, "red");
    document.getElementById("chart").innerHTML = "Error";
  }

  //parse out the various components from a provided Maker API URL
  function parseApiSample(sampleUrl){
    //if we weren't passed in an explicit URL to parse
    if(sampleUrl == null){
      //then try to use the sample API URL from the tile settings
      sampleUrl = tileSettings.apiSample;
    }
    //if no URL was provided, let the user know
    if(sampleUrl == null || sampleUrl === "") showError("No API URL was provided. Please configure the tile.");
    //if the api isn't the cloud API, let the user know
    if(sampleUrl.indexOf("cloud.hubitat.com") < 0) showError("Please use the Hubitat Maker API CLOUD URI.")

    //try to parse out the various parts of the URL we need with a regular expression
    var re = /https:\/\/cloud\.hubitat\.com\/api\/([^\/]+)\/apps\/([\d]+)\/[^\?]+\?access_token\=([^\&]+)/;
    var match = sampleUrl.match(re); //array of the various regex matches (0: full string, 1: hub id, 2: app id, 3: token)

    //pass the parsed settings back into the top-level variable
    apiSettings = { 
      "hubId": match[1], 
      "appId": match[2], 
      "token": match[3]
    };
  }

  //helper function to format the parsed data back into a base URI
  function getBaseUrl(){
    return `https://cloud.hubitat.com/api/${apiSettings.hubId}/apps/${apiSettings.appId}`
  }
  //helper function to format the token into an axios 'data' object to attach the token as a parameter
  function getAxiosConfig(){
    return {params: {access_token: apiSettings.token}};
  }
  
  function initChart() {
    console.log("Initialize Google Chart");
    
    chartData = google.visualization.arrayToDataTable([
      ['Label', 'Value'],
//**************** SET UP Default Gauge Center Label **************
      ['Volts', 0], // Default inside gauge label

    ]);  
    chart = new google.visualization.Gauge(document.getElementById('chart'));
  }
  
  function getDeviceValue(){  
    var url = getBaseUrl() + `/devices/${tileSettings.deviceId}`
    var config = getAxiosConfig();
	
// Set up Units
    var gaugeUnitsDisplay = tileSettings.gaugeUnits
    if(tileSettings.gaugeUnits == null || tileSettings.gaugeUnits == "")
//********************** SET UP Default Units ********************
    {gaugeUnitsDisplay = "V";}  // Default unit if no entry

// Set up number of decimals
    var numDecimalsDisplay = tileSettings.numDecimals
    if (tileSettings.numDecimals == "0") {numDecimalsDisplay = "#";}
    else if (tileSettings.numDecimals == "1") {numDecimalsDisplay = "#.#";}
    else if (tileSettings.numDecimals == "3") {numDecimalsDisplay = "#.###";}
    else {numDecimalsDisplay = "#.##";}  // Default if no entry
    
// Getting the device's attribute reading using Hubitat Maker API
    var hubAttributeDisplay = tileSettings.hubAttribute
    if(tileSettings.hubAttribute == null || tileSettings.hubAttribute == "")
    {hubAttributeDisplay = "0";}  // Default 0 if no entry
    
    axios.get(url, config).then(function(res){
        var value = res.data.attributes[hubAttributeDisplay].currentValue;
        console.log(`Received battery reading: ${value}`);
        //Set chart value and draw chart
        if(chart && chartData){
          chartData.setValue(0, 1, value);

// Apply Units and Decimals
		var formatter = new google.visualization.NumberFormat(
          {suffix: gaugeUnitsDisplay ,pattern:numDecimalsDisplay}  // Edit units and decimal places
        
		);
        formatter.format(chartData,1);

// Apply new gauge center label if entered in tile editor
          if(tileSettings.gaugeLabel != null && tileSettings.gaugeLabel != ""){
            chartData.setValue(0, 0, tileSettings.gaugeLabel);
          }
          chart.draw(chartData, chartOptions);   
        }
      }).catch(function(error){
          showError("Error communicating with Maker API")
      });
  }
  
  function valuePollingScheduler(){
    getDeviceValue();
    var refreshIntervCalc = tileSettings.refreshInterv
    if(tileSettings.refreshInterv == null || tileSettings.refreshInterv == "")
    	{refreshIntervCalc = 10;}  // Default 10 minuts unit if no entry
    console.log("polling value in 5 minutes");
    setTimeout(valuePollingScheduler, (refreshIntervCalc * 60 * 1000)); // Millisec
  }
</script>
 
